name: Build Android APKs (Zashboard & MetaCubeX)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-zashboard:
    name: Build Zashboard Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Download and extract Zashboard
        run: |
          wget -q https://github.com/Zephyruso/zashboard/releases/latest/download/dist-firasans-only.zip
          unzip -q dist-firasans-only.zip
          mv dist zashboard-dist
          
          if [ ! -f "zashboard-dist/index.html" ]; then
            echo "ERROR: index.html not found!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Initialize npm project
        run: |
          cat > package.json << 'EOF'
          {
            "name": "zashboard-android",
            "version": "1.0.0"
          }
          EOF

      - name: Install Capacitor packages
        run: npm install @capacitor/core@6.1.2 @capacitor/cli@6.1.2 @capacitor/android@6.1.2

      - name: Create Capacitor config
        run: |
          cat > capacitor.config.json << 'EOF'
          {
            "appId": "com.zashboard.app",
            "appName": "Zashboard",
            "webDir": "zashboard-dist",
            "server": {
              "androidScheme": "http"
            },
            "android": {
              "allowMixedContent": true
            }
          }
          EOF

      - name: Add Android platform
        run: npx cap add android

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Install ImageMagick for icon processing
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y imagemagick

      - name: Update version numbers
        run: |
          # è·å–ä¸Šæ¸¸ Zashboard çš„ç‰ˆæœ¬å·
          UPSTREAM_VERSION=$(curl -s https://raw.githubusercontent.com/Zephyruso/zashboard/main/package.json | grep -oP '"version":\s*"\K[^"]+')

          # å°†ç‰ˆæœ¬å·è½¬æ¢ä¸º versionCode (ä¾‹å¦‚: 2.0.0 -> 200000)
          MAJOR=$(echo $UPSTREAM_VERSION | cut -d. -f1)
          MINOR=$(echo $UPSTREAM_VERSION | cut -d. -f2)
          PATCH=$(echo $UPSTREAM_VERSION | cut -d. -f3)
          BASE_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))

          # versionCode = åŸºç¡€ç‰ˆæœ¬å· + æ„å»ºç¼–å· (ç¡®ä¿æ¯æ¬¡æ„å»ºéƒ½æ˜¯å”¯ä¸€çš„)
          VERSION_CODE=$((BASE_CODE * 1000 + ${{ github.run_number }}))
          VERSION_NAME="$UPSTREAM_VERSION-build${{ github.run_number }}"

          # æ›´æ–° build.gradle ä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION_NAME\"/" android/app/build.gradle

          echo "âœ“ Upstream version: $UPSTREAM_VERSION"
          echo "âœ“ Version updated to versionCode=$VERSION_CODE, versionName=$VERSION_NAME"

      - name: Configure Android for HTTP support
        run: |
          sed -i 's/<application/<application\n        android:usesCleartextTraffic="true"/' \
            android/app/src/main/AndroidManifest.xml

      - name: Decode signing key from secrets
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > android/app/zashboard-release.keystore
          echo "âœ“ Signing key decoded from secure secrets"

      - name: Configure Gradle signing for Release
        run: |
          cat >> android/app/build.gradle << 'EOF'

          android {
              signingConfigs {
                  release {
                      storeFile file('zashboard-release.keystore')
                      storePassword "${{ secrets.KEYSTORE_PASSWORD }}"
                      keyAlias "${{ secrets.KEY_ALIAS }}"
                      keyPassword "${{ secrets.KEY_PASSWORD }}"
                  }
              }
              buildTypes {
                  debug {
                      signingConfig signingConfigs.release
                  }
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      shrinkResources false
                  }
              }
          }
          EOF
          echo "âœ“ Gradle signing configured for Release build"

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Force replace app icon before build
        run: |
          echo "=== Forcing icon replacement before APK build ==="

          # ä½¿ç”¨ Zashboard çš„é«˜è´¨é‡ PNG å›¾æ ‡
          cd zashboard-dist
          if [ -f "pwa-512x512.png" ]; then
            SOURCE_ICON="pwa-512x512.png"
          elif [ -f "pwa-192x192.png" ]; then
            SOURCE_ICON="pwa-192x192.png"
          else
            echo "ERROR: No suitable icon found!"
            exit 1
          fi

          echo "Using $SOURCE_ICON for Zashboard icon"

          # è½¬æ¢ä¸ºå„ç§ Android åˆ†è¾¨ç‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå»æ‰å¤æ‚å‚æ•°ï¼‰
          convert $SOURCE_ICON -resize 48x48 icon-48.png
          convert $SOURCE_ICON -resize 72x72 icon-72.png
          convert $SOURCE_ICON -resize 96x96 icon-96.png
          convert $SOURCE_ICON -resize 144x144 icon-144.png
          convert $SOURCE_ICON -resize 192x192 icon-192.png
          cd ..

          # æ›¿æ¢æ‰€æœ‰å›¾æ ‡æ–‡ä»¶
          for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            case $density in
              mdpi) size=48 ;;
              hdpi) size=72 ;;
              xhdpi) size=96 ;;
              xxhdpi) size=144 ;;
              xxxhdpi) size=192 ;;
            esac

            MIPMAP_DIR="android/app/src/main/res/mipmap-${density}"

            # å¼ºåˆ¶è¦†ç›–å›¾æ ‡
            cp -f zashboard-dist/icon-${size}.png $MIPMAP_DIR/ic_launcher.png
            cp -f zashboard-dist/icon-${size}.png $MIPMAP_DIR/ic_launcher_round.png
          done

          echo "=== Icon replacement completed ==="
          ls -lh android/app/src/main/res/mipmap-*/ic_launcher.png

      # æ”¹ä¸ºæ„å»ºRelease APK
      - name: Build Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace --no-daemon
        timeout-minutes: 15

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: zashboard-android-release
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

  build-metacubex:
    name: Build MetaCubeX Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Download and extract MetaCubeX
        run: |
          wget -q https://github.com/MetaCubeX/metacubexd/releases/latest/download/compressed-dist.tgz
          mkdir -p metacubex-dist
          tar -xzf compressed-dist.tgz -C metacubex-dist

          if [ ! -f "metacubex-dist/index.html" ]; then
            echo "ERROR: index.html not found!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Initialize npm project
        run: |
          cat > package.json << 'EOF'
          {
            "name": "metacubex-android",
            "version": "1.0.0"
          }
          EOF

      - name: Install Capacitor packages
        run: npm install @capacitor/core@6.1.2 @capacitor/cli@6.1.2 @capacitor/android@6.1.2

      - name: Create Capacitor config
        run: |
          cat > capacitor.config.json << 'EOF'
          {
            "appId": "com.metacubex.app",
            "appName": "MetaCubeX",
            "webDir": "metacubex-dist",
            "server": {
              "androidScheme": "http"
            },
            "android": {
              "allowMixedContent": true
            }
          }
          EOF

      - name: Add Android platform
        run: npx cap add android

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Install ImageMagick for icon processing
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y imagemagick

      - name: Update version numbers
        run: |
          # è·å–ä¸Šæ¸¸ MetaCubeX çš„ç‰ˆæœ¬å·
          UPSTREAM_VERSION=$(curl -sL https://raw.githubusercontent.com/MetaCubeX/metacubexd/main/package.json | grep -oP '"version":\s*"\K[^"]+')

          # å°†ç‰ˆæœ¬å·è½¬æ¢ä¸º versionCode (ä¾‹å¦‚: 2.0.0 -> 200000)
          MAJOR=$(echo $UPSTREAM_VERSION | cut -d. -f1)
          MINOR=$(echo $UPSTREAM_VERSION | cut -d. -f2)
          PATCH=$(echo $UPSTREAM_VERSION | cut -d. -f3)
          BASE_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))

          # versionCode = åŸºç¡€ç‰ˆæœ¬å· + æ„å»ºç¼–å· (ç¡®ä¿æ¯æ¬¡æ„å»ºéƒ½æ˜¯å”¯ä¸€çš„)
          VERSION_CODE=$((BASE_CODE * 1000 + ${{ github.run_number }}))
          VERSION_NAME="$UPSTREAM_VERSION-build${{ github.run_number }}"

          # æ›´æ–° build.gradle ä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION_NAME\"/" android/app/build.gradle

          echo "âœ“ Upstream version: $UPSTREAM_VERSION"
          echo "âœ“ Version updated to versionCode=$VERSION_CODE, versionName=$VERSION_NAME"

      - name: Configure Android for HTTP support
        run: |
          sed -i 's/<application/<application\n        android:usesCleartextTraffic="true"/' \
            android/app/src/main/AndroidManifest.xml

      - name: Decode signing key from secrets
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > android/app/metacubex-release.keystore
          echo "âœ“ Signing key decoded from secure secrets"

      - name: Configure Gradle signing for Release
        run: |
          cat >> android/app/build.gradle << 'EOF'

          android {
              signingConfigs {
                  release {
                      storeFile file('metacubex-release.keystore')
                      storePassword "${{ secrets.KEYSTORE_PASSWORD }}"
                      keyAlias "${{ secrets.KEY_ALIAS }}"
                      keyPassword "${{ secrets.KEY_PASSWORD }}"
                  }
              }
              buildTypes {
                  debug {
                      signingConfig signingConfigs.release
                  }
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      shrinkResources false
                  }
              }
          }
          EOF
          echo "âœ“ Gradle signing configured for Release build"

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Force replace app icon before build
        run: |
          echo "=== Forcing icon replacement before APK build ==="

          # ä½¿ç”¨ MetaCubeX çš„é«˜è´¨é‡ PNG å›¾æ ‡
          cd metacubex-dist
          if [ -f "pwa-512x512.png" ]; then
            SOURCE_ICON="pwa-512x512.png"
          elif [ -f "pwa-192x192.png" ]; then
            SOURCE_ICON="pwa-192x192.png"
          else
            echo "ERROR: No suitable icon found!"
            exit 1
          fi

          echo "Using $SOURCE_ICON for MetaCubeX icon"

          # è½¬æ¢ä¸ºå„ç§ Android åˆ†è¾¨ç‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå»æ‰å¤æ‚å‚æ•°ï¼‰
          convert $SOURCE_ICON -resize 48x48 icon-48.png
          convert $SOURCE_ICON -resize 72x72 icon-72.png
          convert $SOURCE_ICON -resize 96x96 icon-96.png
          convert $SOURCE_ICON -resize 144x144 icon-144.png
          convert $SOURCE_ICON -resize 192x192 icon-192.png
          cd ..

          # æ›¿æ¢æ‰€æœ‰å›¾æ ‡æ–‡ä»¶
          for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            case $density in
              mdpi) size=48 ;;
              hdpi) size=72 ;;
              xhdpi) size=96 ;;
              xxhdpi) size=144 ;;
              xxxhdpi) size=192 ;;
            esac

            MIPMAP_DIR="android/app/src/main/res/mipmap-${density}"

            # å¼ºåˆ¶è¦†ç›–å›¾æ ‡
            cp -f metacubex-dist/icon-${size}.png $MIPMAP_DIR/ic_launcher.png
            cp -f metacubex-dist/icon-${size}.png $MIPMAP_DIR/ic_launcher_round.png
          done

          echo "=== Icon replacement completed ==="
          ls -lh android/app/src/main/res/mipmap-*/ic_launcher.png

      - name: Build Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace --no-daemon
        timeout-minutes: 15

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: metacubex-android-release
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-zashboard, build-metacubex]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download Zashboard APK
        uses: actions/download-artifact@v4
        with:
          name: zashboard-android-release
          path: ./apks/zashboard

      - name: Download MetaCubeX APK
        uses: actions/download-artifact@v4
        with:
          name: metacubex-android-release
          path: ./apks/metacubex

      - name: Get upstream versions
        id: versions
        run: |
          ZASHBOARD_VERSION=$(curl -s https://raw.githubusercontent.com/Zephyruso/zashboard/main/package.json | grep -oP '"version":\s*"\K[^"]+')
          METACUBEX_VERSION=$(curl -sL https://raw.githubusercontent.com/MetaCubeX/metacubexd/main/package.json | grep -oP '"version":\s*"\K[^"]+')
          echo "zashboard=$ZASHBOARD_VERSION" >> $GITHUB_OUTPUT
          echo "metacubex=$METACUBEX_VERSION" >> $GITHUB_OUTPUT
          echo "Zashboard version: $ZASHBOARD_VERSION"
          echo "MetaCubeX version: $METACUBEX_VERSION"

      - name: Rename APK files with version numbers
        run: |
          mv apks/zashboard/app-release.apk apks/zashboard-v${{ steps.versions.outputs.zashboard }}-release.apk
          mv apks/metacubex/app-release.apk apks/metacubex-v${{ steps.versions.outputs.metacubex }}-release.apk
          ls -lh apks/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Android APKs Build ${{ github.run_number }}
          body: |
            ğŸš€ **Android APK Release**

            æœ¬æ¬¡æ„å»ºåŒ…å«ä¸¤ä¸ªç‹¬ç«‹çš„ APKï¼š

            ## ğŸ“¦ Zashboard APK
            - **æ–‡ä»¶å**: `zashboard-v${{ steps.versions.outputs.zashboard }}-release.apk`
            - **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ steps.versions.outputs.zashboard }}
            - **åº”ç”¨ ID**: com.zashboard.app
            - **é¡¹ç›®åœ°å€**: [Zashboard](https://github.com/Zephyruso/zashboard)

            ## ğŸ“¦ MetaCubeX APK
            - **æ–‡ä»¶å**: `metacubex-v${{ steps.versions.outputs.metacubex }}-release.apk`
            - **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ steps.versions.outputs.metacubex }}
            - **åº”ç”¨ ID**: com.metacubex.app
            - **é¡¹ç›®åœ°å€**: [MetaCubeX Dashboard](https://github.com/MetaCubeX/metacubexd)

            ---

            ### ğŸ“ é€šç”¨ä¿¡æ¯
            - **æ„å»ºç¼–å·**: #${{ github.run_number }}
            - **æ„å»ºç±»å‹**: Release (å·²ä¼˜åŒ–)
            - **ç­¾åæ–¹å¼**: ä½¿ç”¨ GitHub Secrets ä¸­çš„å®‰å…¨å¯†é’¥åº“ç­¾å
            - **ç½‘ç»œæ”¯æŒ**: HTTP å’Œ HTTPS å‡æ”¯æŒ

            ### ğŸ“¥ å®‰è£…è¯´æ˜
            - **æ–°ç”¨æˆ·**: ä¸‹è½½å¯¹åº”çš„ APK æ–‡ä»¶å¹¶å®‰è£…
            - **è€ç”¨æˆ·**: å¯ä»¥ç›´æ¥å‡çº§ï¼Œæ— éœ€å¸è½½æ—§ç‰ˆæœ¬
            - **æ³¨æ„**: ç‰ˆæœ¬å·ä¼šè‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸é¡¹ç›®çš„å‘å¸ƒç‰ˆæœ¬

            ### âš™ï¸ é…ç½®è¯´æ˜
            å®‰è£…åéœ€è¦è¿æ¥åˆ°ä½ çš„ Mihomo/Clash æœåŠ¡å™¨ï¼š
            - **æœåŠ¡å™¨åœ°å€**: `http://YOUR_IP:9090` (HTTP) æˆ– `https://YOUR_IP:9443` (HTTPS)
            - **Secret**: ï¼ˆå¦‚å·²é…ç½®åˆ™å¡«å†™ï¼‰

            ### ğŸ” å®‰å…¨æ€§
            - æ‰€æœ‰ APK å‡ä½¿ç”¨åŠ å¯†å¯†é’¥åº“ç­¾å
            - æ”¯æŒæ˜æ–‡æµé‡ï¼ˆusesCleartextTrafficï¼‰ä»¥å…¼å®¹ HTTP è¿æ¥
          files: |
            apks/zashboard-v${{ steps.versions.outputs.zashboard }}-release.apk
            apks/metacubex-v${{ steps.versions.outputs.metacubex }}-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}