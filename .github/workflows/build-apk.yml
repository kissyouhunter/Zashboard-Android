name: Build Zashboard Android

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    name: Build Zashboard Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # 下载并解压Zashboard
      - name: Download and extract Zashboard
        run: |
          echo "Downloading Zashboard prebuilt release..."
          wget -q https://github.com/Zephyruso/zashboard/releases/latest/download/dist-firasans-only.zip
          
          echo "Extracting to zashboard-dist/..."
          mkdir -p zashboard-dist
          unzip -q dist-firasans-only.zip -d zashboard-dist
          
          echo "Verifying structure..."
          ls -lh zashboard-dist/
          
          if [ ! -f "zashboard-dist/index.html" ]; then
            echo "ERROR: index.html not found!"
            exit 1
          fi
          
          echo "✓ Zashboard extracted successfully"

      # 设置Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 初始化npm项目
      - name: Initialize npm project
        run: |
          cat > package.json << 'EOF'
          {
            "name": "zashboard-android",
            "version": "1.0.0",
            "description": "Zashboard Android wrapper",
            "dependencies": {}
          }
          EOF
          echo "✓ package.json created"

      # 安装Capacitor依赖
      - name: Install Capacitor packages
        run: |
          echo "Installing Capacitor dependencies..."
          npm install @capacitor/core @capacitor/cli @capacitor/android
          echo "✓ Capacitor packages installed"

      # 创建Capacitor配置
      - name: Create Capacitor config
        run: |
          cat > capacitor.config.json << 'EOF'
          {
            "appId": "com.zashboard.app",
            "appName": "Zashboard",
            "webDir": "zashboard-dist",
            "server": {
              "androidScheme": "https"
            }
          }
          EOF
          echo "✓ Capacitor config created"

      # 添加Android平台
      - name: Add Android platform
        run: |
          echo "Adding Android platform..."
          npx cap add android
          echo "✓ Android platform added"

      # 同步Web资源到Android
      - name: Sync Capacitor
        run: |
          echo "Syncing web assets..."
          npx cap sync android
          echo "✓ Sync completed"

      # 配置Android权限和设置
      - name: Configure Android
        run: |
          echo "Configuring AndroidManifest.xml..."
          
          # 添加网络权限
          sed -i '/<manifest/a\
              <uses-permission android:name="android.permission.INTERNET" />\
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' \
            android/app/src/main/AndroidManifest.xml
          
          echo "✓ Permissions added"
          
          # 验证
          echo "Verifying AndroidManifest.xml:"
          grep -A 3 "<manifest" android/app/src/main/AndroidManifest.xml || true

      # 设置JDK
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 设置Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 构建APK
      - name: Build Debug APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace --no-daemon
        timeout-minutes: 15

      # 列出生成的APK
      - name: List generated APKs
        run: |
          echo "Generated APK files:"
          find android/app/build/outputs/apk -name "*.apk" -exec ls -lh {} \;

      # 上传APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: zashboard-android-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      # 创建Release
      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Zashboard Android v${{ github.run_number }}
          body: |
            Zashboard Android APK - Auto build #${{ github.run_number }}
            
            Based on Zashboard latest release
            Built with Capacitor
            
            ## Installation
            1. Download the APK file below
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK
            4. Open the app and configure your Mihomo server address
          files: android/app/build/outputs/apk/debug/app-debug.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
